<!DOCTYPE html>
<html>

<head>
    <title>Fonte-Inteligente</title>
    <meta charset="UTF-8">
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .navbar {
            width: 100vw;
            height: 10vh;
            background-color: rgb(26, 26, 180);
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding-left: 20px;
            color: white;
            position: relative;
        }

        .navbar h1 {
            font-size: 1.8em;
        }

        .conteiner {
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: center;
            background-color: #fff;
            min-height: 90vh;
            width: 100vw;
            padding: 20px;
            flex-wrap: wrap;
        }

        .status-card {
            display: none;
            padding: 10px;
            border-radius: 6px;
            font-weight: bold;
            text-align: center;
        }

        .status-connecting {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .cards,
        .card-historico {
            height: 60vh;
            display: flex;
            flex-direction: column;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            border: 1px solid #e0e0e0;
            padding: 10px;
            align-items: center;
            justify-content: center;
        }

        .cards {
            align-items: center;
            width: calc(25% - 13.33px);
            padding: 20px;
        }

        .card-historico {
            align-items: flex-start;
            justify-content: flex-start;
            width: calc(40% - 13.33px);
            padding-left: 0;
            padding-right: 0;
        }

        .titulo {
            color: rgb(26, 26, 180);
            font-weight: 700;
            text-align: center;
            padding: 10px 0;
            width: 100%;
        }

        .card-content {
            color: #000;
            padding: 10px;
            font-size: 1.2em;
            text-align: center;
            width: 100%;
        }

        .data-item {
            display: flex;
            justify-content: space-between;
            width: 90%;
            padding: 5px 0;
            border-bottom: 1px dashed #ccc;
            margin-left: auto;
            margin-right: auto;
        }

        .data-label {
            font-weight: 500;
            color: #555;
        }

        .data-value {
            font-weight: bold;
            color: #000;
        }

        .battery-icon-svg {
            width: 1.5em;
            height: 1.5em;
            fill: rgb(48, 48, 221);
            stroke: rgb(26, 26, 180);
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            margin: 10px 0;
        }

        .battery-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 5.5em;
            color: rgb(26, 26, 180);
            margin: 10px 0;
        }

        .battery-display {
            display: flex;
            align-items: center;
            margin-top: 5px;
        }

        .battery-indicator .percentage {
            font-size: 0.5em;
            font-weight: 700;
            color: #000;
            margin-top: 0;
        }

        .historico-wrapper {
            max-height: 48vh;
            overflow-y: auto;
            width: 100%;
            margin-top: 10px;
            padding: 0 10px;
        }

        .historico-tabela {
            width: 100%;
            border-collapse: collapse;
            color: #333;
            font-size: 0.9em;
        }

        .historico-tabela th,
        .historico-tabela td {
            border: none;
            padding: 12px 8px;
            text-align: center;
        }

        .historico-tabela th {
            background-color: #e6f0ff;
            color: rgb(26, 26, 180);
            font-weight: bold;
            border-bottom: 2px solid rgb(26, 26, 180);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .historico-tabela tbody tr {
            border-bottom: 1px solid #eee;
        }

        .historico-tabela tbody tr:last-child {
            border-bottom: none;
        }

        .historico-tabela tbody tr:nth-child(even) {
            background-color: #f7f7f7;
        }

        #connect-btn {
            position: absolute;
            right: 20px;
            color: white;
            background: none;
            border: 2px solid white;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            padding: 30px;
            border-radius: 8px;
            width: 80%;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .close-btn {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-btn:hover {
            color: #000;
        }

        .modal-content input[type="text"],
        .modal-content input[type="password"] {
            width: 100%;
            padding: 10px;
            margin: 5px 0 15px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .modal-content button[type="submit"] {
            background-color: rgb(26, 26, 180);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
        }


        @media (max-width: 1024px) {
            .conteiner {
                justify-content: flex-start;
            }

            .cards {
                width: calc(50% - 10px);
            }

            .card-historico {
                width: 100%;
                margin-top: 20px;
                padding-left: 10px;
                padding-right: 10px;
            }

            .historico-wrapper {
                max-height: 400px;
            }
        }

        @media (max-width: 600px) {
            .conteiner {
                padding: 10px;
            }

            .navbar h1 {
                font-size: 1.4em;
            }

            .cards,
            .card-historico {
                width: 100%;
                margin-top: 10px;
                padding: 15px;
            }

            .card-historico {
                padding-left: 15px;
                padding-right: 15px;
            }

            .battery-indicator {
                font-size: 4em;
            }

            .historico-wrapper {
                max-height: 300px;
                padding: 0;
            }

            #connect-btn {
                padding: 3px 6px;
                font-size: 0.9em;
            }
        }
    </style>
</head>

<body>
    <div class="navbar">
        <h1>Fonte inteligente Ledax</h1>
        <button id="connect-btn" onclick="document.getElementById('wifiModal').style.display='flex'">Conectar</button>
    </div>

    <div class="conteiner">
        <div class="cards">
            <h2 class="titulo">Fonte Ativa</h2>
            <div class="card-content" style="font-size: 1.5em; font-weight: bold; color: rgb(243, 190, 16);"
                id="redeAtiva">--</div>

            <div
                style="width: 100%; margin-top: 30px; display: flex; flex-direction: column; align-items: center; /* REMOVIDO: flex-grow: 1; */">
                <div class="data-item">
                    <span class="data-label">Tensão da Rede:</span>
                    <span class="data-value" id="tensaoRedeValue">-- V</span>
                </div>
                <div class="data-item">
                    <span class="data-label">Tensão da Bateria:</span>
                    <span class="data-value" id="tensaoBateria">-- V</span>
                </div>
            </div>
        </div>

        <div class="cards">
            <h2 class="titulo">Nível da Bateria</h2>
            <div class="battery-indicator">
                <svg class="battery-icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 24"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="2" y="5" width="26" height="14" rx="1" ry="1"></rect>
                    <line x1="30" y1="9" x2="30" y2="15"></line>
                </svg>

                <div class="battery-display">
                    <span class="percentage" id="porcentagemBateria">--%</span>
                </div>
            </div>

            <div class="data-item"
                style="border: none; margin-top: 20px; width: 90%; /* REMOVIDO: flex-grow: 1; align-items: flex-end; */">
                <span class="data-label">Estado:</span>
                <span class="data-value" style="color: green;" id="estado"">--</span>
            </div>
        </div>

        <div class=" card-historico">
                    <h2 class="titulo">Histórico</h2>
                    <div class="historico-wrapper">
                        <table class="historico-tabela">
                            <thead>
                                <tr>
                                    <th>Tipo</th>
                                    <th>Data/Hora</th>
                                    <th>Bateria (%)</th>
                                </tr>
                            </thead>
                            <!-- (MODIFICADO) ID adicionado e conteúdo estático removido -->
                            <tbody id="log-table-body">
                                <tr>
                                    <!-- Placeholder inicial -->
                                    <td colspan="3" style="text-align: center; color: #888;">Carregando logs...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
            </div>
        </div>

        <div id="wifiModal" class="modal">
            <div class="modal-content">
                <span class="close-btn"
                    onclick="document.getElementById('wifiModal').style.display='none'">&times;</span>
                <h3 class="titulo" style="margin-bottom: 0;">Conectar à Rede Wi-Fi</h3>

                <form action="/connect" method="POST" id="wifiForm">
                    <label for="ssid">Nome da Rede (SSID):</label>
                    <input type="text" id="ssid" name="ssid" placeholder="Ex: MinhaCasa" required>
                    <label for="password">Senha:</label>
                    <input type="password" id="password" name="password" placeholder="Mínimo 8 caracteres" required
                        minlength="8">
                    <button type="submit">Conectar</button>
                </form>
                <div id="statusCard" class="status-card"></div>

            </div>
        </div>

        <!-- =================================================================== -->
        <!-- (MODIFICADO) JAVASCRIPT ATUALIZADO COM LÓGICA DE POLLING -->
        <!-- =================================================================== -->
        <script>
            // --- (NOVO) Variáveis globais para o polling do histórico ---
            let ultimoLogID = 0;
            let isFirstLogLoad = true; // Controla a msg "Carregando..."

            // --- Lógica do Modal (existente) ---
            var modal = document.getElementById('wifiModal');
            window.onclick = function (event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }

            // --- Função para dados em tempo real (existente) ---
            function fetchData() {
                fetch('/data')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("falha na resposta da rede: " + response.statusText);
                        }
                        return response.json();
                    })
                    .then(data => {
                        // console.log("Dados recebidos: ", data); // Descomente para depurar

                        document.getElementById('tensaoRedeValue').textContent = data.tensaoRede.toFixed(1) + "V";
                        document.getElementById('tensaoBateria').textContent = data.tensaoBateria.toFixed(2) + "V"; // (Ajustado para 2 casas)
                        document.getElementById("porcentagemBateria").textContent = data.porcentagemBateria.toFixed(0) + "%";

                        const redeAtivaEl = document.getElementById("redeAtiva");
                        redeAtivaEl.textContent = data.redeAtiva;
                        // (NOVO) Muda a cor da fonte ativa
                        if (data.redeAtiva === "REDE EXTERNA") {
                            redeAtivaEl.style.color = 'rgb(26, 26, 180)'; // Azul
                        } else {
                            redeAtivaEl.style.color = 'rgb(243, 190, 16)'; // Amarelo
                        }

                        const estadoEl = document.getElementById("estado");
                        estadoEl.textContent = data.estado;
                        // (NOVO) Muda a cor do estado
                        if (data.estado === "Carregando") {
                            estadoEl.style.color = 'green';
                        } else if (data.estado === "Descarregando") {
                            estadoEl.style.color = 'orange';
                        } else {
                            estadoEl.style.color = 'blue'; // Carga Completa
                        }
                    })
                    .catch(error => {
                        console.error("Erro ao buscar dados: " + error);
                        document.getElementById('redeAtiva').textContent = "Erro";
                        document.getElementById('redeAtiva').style.color = 'red';
                    });
            }

            // --- (NOVO) Função para criar linha da tabela de log ---
            function createLogRow(log) {
                const row = document.createElement('tr');

                // Define o estilo com base no tipo de evento
                let tipoEstilo = 'color: #333;'; // Padrão
                if (log.tipo === 'QUEDA') {
                    tipoEstilo = 'color: red; font-weight: bold;';
                } else if (log.tipo === 'RETORNO') {
                    tipoEstilo = 'color: green; font-weight: bold;';
                }

                // (IMPORTANTE) A ordem das colunas DEVE bater com seu HTML:
                // 1. Tipo, 2. Data/Hora, 3. Bateria (%)

                // Coluna 1: Tipo
                const cellTipo = document.createElement('td');
                cellTipo.textContent = log.tipo;
                cellTipo.style.cssText = tipoEstilo;

                // Coluna 2: Data/Hora
                const cellData = document.createElement('td');
                cellData.textContent = log.data_hora;

                // Coluna 3: Bateria
                const cellBateria = document.createElement('td');
                cellBateria.textContent = log.bateria_perc.toFixed(1) + "%";

                row.appendChild(cellTipo);
                row.appendChild(cellData);
                row.appendChild(cellBateria);
                return row;
            }

            async function fetchInitialLogs() {
                console.log("Buscando /historico (carga inicial)");
                const tableBody = document.getElementById('log-table-body');

                try {
                    // (IMPORTANTE) Usando a rota /historico
                    const response = await fetch('/historico');
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                    const logs = await response.json();

                    tableBody.innerHTML = ''; // Limpa o "Carregando..."
                    isFirstLogLoad = false;

                    if (logs.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #888;">Nenhum log encontrado.</td></tr>';
                        return;
                    }
                    ultimoLogID = logs[0].id;
                    console.log("Log mais recente ID:", ultimoLogID);

                    // Preenche a tabela
                    logs.forEach(log => {
                        const row = createLogRow(log);
                        tableBody.appendChild(row); // Adiciona no final (ordem DESC)
                    });

                } catch (error) {
                    console.error("Falha ao buscar logs iniciais: ", error);
                    tableBody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: red;">Falha ao carregar logs.</td></tr>';
                }
            }

            // --- (NOVO) Função para buscar *NOVOS* logs (Polling) ---
            async function fetchNewLogs() {
                if (isFirstLogLoad) {
                    // Não busca novos logs até que os iniciais tenham sido carregados
                    return;
                }

                console.log("Buscando /historico/new?sinceID=" + ultimoLogID);
                const tableBody = document.getElementById('log-table-body');

                try {
                    // (IMPORTANTE) Chama a nova rota de API
                    const response = await fetch(`/historico/new?sinceID=${ultimoLogID}`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                    const newLogs = await response.json();

                    if (newLogs.length === 0) {
                        // Isso é o normal. Nenhum log novo.
                        return;
                    }

                    console.log(`Recebidos ${newLogs.length} novos logs.`);

                    // Remove a mensagem "Nenhum log encontrado" se ela existir
                    const noLogMessage = tableBody.querySelector('td[colspan="3"]');
                    if (noLogMessage) noLogMessage.parentElement.remove();

                    // Adiciona os novos logs no TOPO da tabela
                    newLogs.forEach(log => {
                        const row = createLogRow(log);
                        tableBody.prepend(row); // .prepend() adiciona no início
                    });

                    // (IMPORTANTE) Atualiza o ultimoLogID com o ID mais recente
                    // Como a query é ASC, o mais recente é o último
                    ultimoLogID = newLogs[newLogs.length - 1].id;
                    console.log("Novo log mais recente ID:", ultimoLogID);

                } catch (error) {
                    console.error("Falha ao buscar novos logs: ", error);
                }
            }

            function enviarCredenciaisWiFi(event) {
                event.preventDefault();

                const ssid = document.getElementById("ssid").value;
                const password = document.getElementById("password").value;
                const statusCard = document.getElementById("statusCard");

                // Mostra o card "Tentando conectar..."
                statusCard.style.display = "block";
                statusCard.className = "status-card status-connecting";
                statusCard.textContent = "Tentando conectar...";

                fetch('/connect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: 'ssid=' + encodeURIComponent(ssid) + '&password=' + encodeURIComponent(password)
                })
                    .then(response => response.text())
                    .then(data => {
                        if (data.toLowerCase().includes("sucesso")) {
                            statusCard.className = "status-card status-success";
                            statusCard.textContent = "Conectado com sucesso!";
                            setTimeout(() => {
                                document.getElementById('wifiModal').style.display = 'none';
                                statusCard.style.display = "none";
                            }, 2000);
                        } else {
                            statusCard.className = "status-card status-error";
                            statusCard.textContent = data;
                        }
                    })
                    .catch(error => {
                        statusCard.className = "status-card status-error";
                        statusCard.textContent = "Erro ao conectar ao servidor.";
                    });
            }


            document.getElementById("wifiForm").addEventListener("submit", enviarCredenciaisWiFi);

            // --- (MODIFICADO) Inicialização ---
            window.onload = function () {
                // Inicia a busca de dados em tempo real
                fetchData();
                setInterval(fetchData, 1000);

                fetchInitialLogs(); // Busca a carga inicial
                setInterval(fetchNewLogs, 10000); // Verifica por novos logs a cada 5s
            }

        </script>
</body>

</html>