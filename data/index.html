<!DOCTYPE html>
<html>
<head>
<title>Fonte Inteligente</title>
<meta charset="UTF-8">
<meta name='viewport' content='width=device-width, initial-scale=1'>
<style>
*{margin:0;padding:0;box-sizing:border-box}
.navbar{width:100vw;height:10vh;background-color:rgb(26,26,180);display:flex;flex-direction:row;align-items:center;justify-content:space-between;padding:0 10px 0 20px;color:white;position:relative}
.navbar-top{display:flex;align-items:center;width:auto}
.navbar h1{font-size:1.4em;margin-right:10px}
.navbar-info{display:none}
.navbar-btns{position:static;transform:none;display:flex;gap:5px}
.conteiner{display:flex;gap:20px;align-items:stretch;justify-content:center;background-color:#fff;min-height:90vh;max-height:90vh;width:100vw;padding:20px;flex-wrap:wrap}
.status-card{display:none;padding:10px;border-radius:6px;font-weight:700;text-align:center;margin-top:15px}
.status-connecting{background-color:#fff3cd;color:#856404;border:1px solid #ffeeba}
.status-success{background-color:#d4edda;color:#155724;border:1px solid #c3e6cb}
.status-error{background-color:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
.cards,.card-historico{height:70vh;display:flex;flex-direction:column;background-color:#fff;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.15);border:1px solid #e0e0e0;padding:10px}
.titulo{color:rgb(26,26,180);font-weight:700;text-align:center;padding:10px 0;width:100%}
.card-content{color:#000;padding:10px;font-size:1.2em;text-align:center;width:100%}
.data-item{display:flex;justify-content:space-between;width:90%;padding:5px 0;border-bottom:1px dashed #ccc;margin-left:auto;margin-right:auto}
.data-label{font-weight:500;color:#555}
.data-value{font-weight:700;color:#000}
.battery-icon-svg{width:1.5em;height:1.5em;fill:rgb(48,48,221);stroke:rgb(26,26,180);stroke-width:2;stroke-linecap:round;stroke-linejoin:round;margin:10px 0}
.battery-indicator{display:flex;flex-direction:column;align-items:center;font-size:5.5em;color:rgb(26,26,180);margin:10px 0;height:auto}
.battery-display{display:flex;align-items:center;margin-top:5px}
.battery-indicator .percentage{font-size:.5em;font-weight:700;color:#000;margin-top:0}
.historico-wrapper{height:calc(100% - 60px);overflow-y:auto;width:100%;margin-top:10px;padding:0 10px}
.historico-tabela{width:100%;border-collapse:collapse;color:#333;font-size:.9em}
.historico-tabela th,.historico-tabela td{border:none;padding:12px 8px;text-align:center}
.historico-tabela th{background-color:#e6f0ff;color:rgb(26,26,180);font-weight:700;border-bottom:2px solid rgb(26,26,180);position:sticky;top:0;z-index:10}
.historico-tabela tbody tr{border-bottom:1px solid #eee}
.historico-tabela tbody tr:last-child{border-bottom:none}
.historico-tabela tbody tr:nth-child(even){background-color:#f7f7f7}
.nav-btn{color:white;background:none;border:2px solid white;border-radius:4px;padding:5px 10px;font-size:1em;font-weight:700;cursor:pointer;margin-left:10px}
.modal{display:none;position:fixed;z-index:100;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,.5);justify-content:center;align-items:center}
.modal-content{background-color:#fefefe;padding:30px;border-radius:8px;width:80%;max-width:400px;box-shadow:0 4px 12px rgba(0,0,0,.25);position:relative;display:flex;flex-direction:column;gap:15px}
.close-btn{color:#aaa;position:absolute;top:10px;right:15px;font-size:28px;font-weight:700;cursor:pointer}
.close-btn:hover{color:#000}
.modal-content input[type="text"],.modal-content input[type="password"]{width:100%;padding:10px;margin:5px 0 15px;border:1px solid #ccc;border-radius:4px;box-sizing:border-box}
.modal-content button[type="submit"]{background-color:rgb(26,26,180);color:white;padding:10px 15px;border:none;border-radius:4px;cursor:pointer;font-size:1em;font-weight:700}
@media (min-width:768px){
	.navbar{flex-direction:column;align-items:flex-start;justify-content:center;padding-left:20px;padding-right:20px}
	.navbar-top{width:100%}
	.navbar h1{font-size:1.8em;margin-right:20px}
	.navbar-info{display:flex;flex-direction:row;font-size:.9em;line-height:1.2;gap:15px;margin-top:5px;position:static;transform:none;padding-left:0}
	.navbar-btns{position:absolute;right:20px;top:50%;transform:translateY(-50%);gap:10px}
}
@media (min-width:1025px){
	.cards{width:calc(30% - 13.33px);padding:20px}
	.card-historico{width:calc(40% - 13.33px);padding-left:0;padding-right:0}
}
@media (max-width:1024px){
	.navbar{height:auto;flex-direction:column;align-items:flex-start;justify-content:center;padding-top:10px;padding-bottom:10px}
	.navbar-top{width:100%;display:flex;justify-content:space-between;align-items:center}
	.navbar-btns{position:absolute;right:20px;top:50%;transform:translateY(-50%);display:flex}
	.navbar-info{display:flex;flex-direction:column;font-size:.8em;line-height:1.3;margin-top:5px;margin-left:0;padding-left:0;position:static;transform:none}
	.conteiner{align-items:flex-start;max-height:none;min-height:auto}
	.cards{width:calc(50% - 10px);min-height:40vh}
	.card-historico{width:100%;margin-top:20px;padding-left:10px;padding-right:10px;height:100vh}
	.historico-wrapper{height:calc(100% - 60px)}
}
@media (max-width:600px){
	.conteiner{padding:10px}
	.navbar-btns{right:10px;top:15px;transform:none}
	.navbar h1{font-size:1.0em}
	.navbar-info{font-size:.75em}
	.cards,.card-historico{width:100%;margin-top:10px;padding:15px}
	.cards{height:35vh}
	.card-historico{padding-left:15px;padding-right:15px;height:100vh}
	.battery-indicator{font-size:3.5em}
	.nav-btn{padding:3px 6px;font-size:.9em}
}
</style>
</head>
<body>
<div class="navbar">
	<div class="navbar-top">
		<h1 id="navbarTitle">Fonte Inteligente</h1>
	</div>
	<div class="navbar-info">
		<span id="navbarApelido">Apelido: Carregando...</span>
		<span id="navbarId">ID: Gerando...</span>
	</div>
	<div class="navbar-btns">
		<button id="config-btn" class="nav-btn" onclick="openConfigModal()">Configurações</button>
		<button id="connect-btn" class="nav-btn" onclick="openWifiModal()">Conectar</button>
	</div>
</div>
<div class="conteiner">
	<div class="cards">
		<h2 class="titulo">Fonte Ativa</h2>
		<div class="card-content" style="font-size:1.5em;font-weight:bold;color:rgb(243,190,16);" id="redeAtiva">--</div>
		<div style="width:100%;margin-top:30px;display:flex;flex-direction:column;align-items:center;">
			<div class="data-item">
				<span class="data-label">Tensão da Rede:</span>
				<span class="data-value" id="tensaoRedeValue">-- V</span>
			</div>
			<div class="data-item">
				<span class="data-label">Tensão da Bateria:</span>
				<span class="data-value" id="tensaoBateria">-- V</span>
			</div>
		</div>
	</div>
	<div class="cards">
		<h2 class="titulo">Nível da Bateria</h2>
		<div class="battery-indicator">
			<svg class="battery-icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
				<rect x="2" y="5" width="26" height="14" rx="1" ry="1"></rect>
				<line x1="30" y1="9" x2="30" y2="15"></line>
			</svg>
			<div class="battery-display">
				<span class="percentage" id="porcentagemBateria">--%</span>
			</div>
		</div>
		<div class="data-item" style="border:none;margin-top:20px;width:90%;">
			<span class="data-label">Estado:</span>
			<span class="data-value" style="color:green;" id="estado">--</span>
		</div>
	</div>
	<div class="card-historico">
		<h2 class="titulo">Histórico</h2>
		<div class="historico-wrapper">
			<table class="historico-tabela">
				<thead>
					<tr>
						<th>Tipo</th>
						<th>Data/Hora</th>
						<th>Bateria (%)</th>
					</tr>
				</thead>
				<tbody id="log-table-body">
					<tr>
						<td colspan="3" style="text-align:center;color:#888;">Carregando logs...</td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>
</div>
<div id="wifiModal" class="modal">
	<div class="modal-content">
		<span class="close-btn" onclick="document.getElementById('wifiModal').style.display='none'; document.getElementById('wifiStatusCard').style.display='none'">&times;</span>
		<h3 class="titulo" style="margin-bottom:0;">Conectar à Rede Wi-Fi</h3>
		<form action="/connect" method="POST" id="wifiForm">
			<label for="ssid">Nome da Rede (SSID):</label>
			<input type="text" id="ssid" name="ssid" placeholder="Ex: MinhaCasa" required>
			<label for="password">Senha:</label>
			<input type="password" id="password" name="password" placeholder="Mínimo 8 caracteres" required minlength="8">
			<button type="submit">Conectar</button>
		</form>
		<div id="wifiStatusCard" class="status-card"></div>
	</div>
</div>
<div id="configModal" class="modal">
	<div class="modal-content">
		<span class="close-btn" onclick="document.getElementById('configModal').style.display='none'; document.getElementById('configStatusCard').style.display='none'">&times;</span>
		<h3 class="titulo" style="margin-bottom:0;">Configurações do Dispositivo</h3>
		<div style="width:100%;text-align:center;">
			<label class="data-label" for="inputApelidoModal" style="display:block;margin-bottom:5px;">Apelido da Fonte:</label>
			<input type="text" id="inputApelidoModal" placeholder="Carregando..." style="width:90%;padding:8px;margin:0 0 15px 0;border:1px solid #ccc;border-radius:4px;text-align:center;box-sizing:border-box;">
			<button onclick="salvarApelidoModal()" style="background-color:rgb(26,26,180);color:white;border:none;padding:10px 15px;border-radius:4px;cursor:pointer;font-weight:bold;">
				Salvar Apelido
			</button>
		</div>
		<div id="configStatusCard" class="status-card"></div>
	</div>
</div>
<script>
let lastLogID = 0;
let isFirstLog = true;
const wifiModal = document.getElementById('wifiModal');
const configModal = document.getElementById('configModal');
const tableBody = document.getElementById('log-table-body');
const d = (id) => document.getElementById(id); // Helper

window.onclick = function (e) {
	if (e.target === wifiModal) { wifiModal.style.display = "none"; d('wifiStatusCard').style.display = 'none'; }
	if (e.target === configModal) { configModal.style.display = "none"; d('configStatusCard').style.display = 'none'; }
};

function openConfigModal() {
	d('inputApelidoModal').value = d('navbarApelido').textContent.replace('Apelido: ', '').trim() || "";
	d('configStatusCard').style.display = 'none';
	configModal.style.display = 'flex';
}

function openWifiModal() {
	d('wifiStatusCard').style.display = 'none';
	wifiModal.style.display = 'flex';
}

async function fetchData() {
	try {
		const res = await fetch('/data');
		if (!res.ok) throw new Error("Falha na rede: " + res.statusText);
		const data = await res.json();

		d('tensaoRedeValue').textContent = data.tensaoRede.toFixed(3) + "V";
		d('tensaoBateria').textContent = data.tensaoBateria.toFixed(3) + "V";
		d("porcentagemBateria").textContent = data.porcentagemBateria.toFixed(0) + "%";
		d('navbarId').textContent = "ID: " + (data.id || "Gerando...");
		d('navbarApelido').textContent = "Apelido: " + (data.apelido || "Fonte Inteligente");

		const redeEl = d("redeAtiva");
		redeEl.textContent = data.redeAtiva;
		redeEl.style.color = data.redeAtiva === "REDE EXTERNA" ? 'rgb(26,26,180)' : 'rgb(243,190,16)';

		const estadoEl = d("estado");
		estadoEl.textContent = data.estado;
		estadoEl.style.color = data.estado === "Carregando" ? 'green' : (data.estado === "Descarregando" ? 'orange' : 'blue');
	} catch (error) {
		console.error("Erro ao buscar dados: " + error);
		d('redeAtiva').textContent = "Erro";
		d('redeAtiva').style.color = 'red';
	}
}

function showStatus(cardId, type, msg) {
	const card = d(cardId);
	card.style.display = "block";
	card.className = "status-card status-" + type;
	card.textContent = msg;
}

async function salvarApelidoModal() {
	const apelido = d('inputApelidoModal').value.trim();
	if (!apelido) { showStatus("configStatusCard", "error", "Digite um nome válido!"); return; }

	showStatus("configStatusCard", "connecting", "Tentando salvar...");

	try {
		const res = await fetch('/salvar-apelido', {
			method: 'POST',
			headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
			body: 'apelido=' + encodeURIComponent(apelido)
		});
		const msg = await res.text();
		
		if (msg.toLowerCase().includes("sucesso") || msg.toLowerCase().includes("salvo") || msg.toLowerCase().includes("atualizado")) {
			showStatus("configStatusCard", "success", "Apelido atualizado com sucesso!");
			fetchData();
			setTimeout(() => {
				configModal.style.display = 'none';
				d('configStatusCard').style.display = "none";
			}, 2000);
		} else {
			showStatus("configStatusCard", "error", msg);
		}
	} catch (err) {
		showStatus("configStatusCard", "error", "Erro ao salvar: " + err);
	}
}

function createLogRow(log) {
	const row = document.createElement('tr');
	let tipoEstilo = 'color: #333;';
	if (log.tipo === 'QUEDA') tipoEstilo = 'color:red;font-weight:bold;';
	else if (log.tipo === 'RETORNO') tipoEstilo = 'color:green;font-weight:bold;';

	row.innerHTML = `<td style="${tipoEstilo}">${log.tipo}</td><td>${log.data_hora}</td><td>${log.bateria_perc.toFixed(1)}%</td>`;
	return row;
}

async function fetchLogs() {
	const url = isFirstLog ? '/historico' : `/historico/new?sinceID=${lastLogID}`;
	
	try {
		const res = await fetch(url);
		if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
		const logs = await res.json();
		
		if (isFirstLog) {
			tableBody.innerHTML = '';
			if (logs.length === 0) {
				tableBody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#888;">Nenhum log encontrado.</td></tr>';
				return;
			}
		} else if (logs.length === 0) {
			return;
		}

		logs.sort((a, b) => b.id - a.id);
		lastLogID = logs[0].id;
		
		const noLogMsg = tableBody.querySelector('td[colspan="3"]');
		if (noLogMsg && !isFirstLog) noLogMsg.parentElement.remove();

		logs.forEach(log => {
			const row = createLogRow(log);
			if (isFirstLog) tableBody.appendChild(row);
			else tableBody.prepend(row);
		});

		if (isFirstLog) isFirstLog = false;

	} catch (error) {
		console.error("Falha ao buscar logs: ", error);
		if(isFirstLog) tableBody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:red;">Falha ao carregar logs.</td></tr>';
	}
}

async function enviarCredenciaisWiFi(e) {
	e.preventDefault();
	const ssid = d("ssid").value;
	const password = d("password").value;
	showStatus("wifiStatusCard", "connecting", "Tentando conectar...");

	try {
		const res = await fetch('/connect', {
			method: 'POST',
			headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
			body: 'ssid=' + encodeURIComponent(ssid) + '&password=' + encodeURIComponent(password)
		});
		const data = await res.text();

		if (data.toLowerCase().includes("conectado") || data.toLowerCase().includes("sucesso")) {
			showStatus("wifiStatusCard", "success", "Conectado com sucesso!");
			setTimeout(() => {
				wifiModal.style.display = 'none';
				d('wifiStatusCard').style.display = "none";
			}, 2000);
		} else {
			showStatus("wifiStatusCard", "error", data);
		}
	} catch (error) {
		showStatus("wifiStatusCard", "error", "Erro ao conectar ao servidor.");
	}
}

d("wifiForm").addEventListener("submit", enviarCredenciaisWiFi);

window.onload = function () {
	fetchData();
	setInterval(fetchData, 1000);
	
	fetchLogs(); // Carga inicial
	setInterval(fetchLogs, 10000); // Logs novos a cada 10s
};
</script>
</body>
</html>